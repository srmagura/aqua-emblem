// Generated by CoffeeScript 1.12.2
(function() {
  _map.VICTORY_CONDITION = {
    ROUT: {
      text: 'Defeat all enemies'
    }
  };

  _map.Chapter = (function() {
    function Chapter(ui1, map) {
      this.ui = ui1;
      this.map = map;
      this.done = false;
      this.map.ui = this.ui;
      this.playerTurn = new _turn.PlayerTurn(this.ui);
      this.enemyTurn = new _turn.EnemyTurn(this.ui);
      this.turnIndex = 0;
    }

    Chapter.prototype.setPlayerTeam = function(playerTeam) {
      this.playerTeam = playerTeam;
      return this.initUnits();
    };

    Chapter.prototype.initUnits = function() {
      var bonus, i, j, k, l, len, len1, len2, ref, ref1, ref2, results, stat, unit;
      this.units = [];
      ref = this.playerTeam.units;
      for (k = i = 0, len = ref.length; i < len; k = ++i) {
        unit = ref[k];
        unit.pos = this.map.playerPositions[k];
        this.units.push(unit);
        unit.team = this.playerTeam;
        bonus = this.ui.file.difficulty.statBonus;
        for (stat in unit.startStats) {
          if (stat !== 'move') {
            unit.startStats[stat] += bonus;
          }
        }
        unit.calcStatsInitial();
      }
      ref1 = this.enemyTeam.units;
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        unit = ref1[j];
        this.units.push(unit);
        unit.team = this.enemyTeam;
      }
      ref2 = this.units;
      results = [];
      for (l = 0, len2 = ref2.length; l < len2; l++) {
        unit = ref2[l];
        unit.ui = this.ui;
        results.push(unit.calcCombatStats());
      }
      return results;
    };

    Chapter.prototype.addUnit = function(team, unit) {
      this.units.push(unit);
      return team.units.push(unit);
    };

    Chapter.prototype.getUnitAt = function(pos) {
      var i, len, ref, unit;
      ref = this.units;
      for (i = 0, len = ref.length; i < len; i++) {
        unit = ref[i];
        if (unit.pos.equals(pos)) {
          return unit;
        }
      }
      return null;
    };

    Chapter.prototype.kill = function(unit) {
      var removeFrom;
      removeFrom = function(array) {
        var i, k, len, results, u;
        results = [];
        for (k = i = 0, len = array.length; i < len; k = ++i) {
          u = array[k];
          if (u === unit) {
            array.splice(k, 1);
            break;
          } else {
            results.push(void 0);
          }
        }
        return results;
      };
      removeFrom(this.units);
      removeFrom(unit.team.units);
      if (unit.team instanceof _team.PlayerTeam) {
        this.defeat();
        return false;
      }
      return !this.checkConditions();
    };

    Chapter.prototype.checkConditions = function() {
      var victory;
      victory = false;
      if (this.victoryCondition === _map.VICTORY_CONDITION.ROUT) {
        victory = this.enemyTeam.units.length === 0;
      }
      if (victory) {
        this.ui.messageBox.showVictoryMessage();
        this.ui.unitInfoBox.hide();
        this.done = true;
        return true;
      } else {
        return false;
      }
    };

    Chapter.prototype.defeat = function() {
      this.done = true;
      this.ui.unitInfoBox.hide();
      return this.ui.messageBox.showDefeatMessage();
    };

    Chapter.prototype.initTurn = function(team) {
      var callback, doneFlags, i, j, l, len, len1, len2, ref, ref1, ref2, unit;
      ref = this.units;
      for (i = 0, len = ref.length; i < len; i++) {
        unit = ref[i];
        unit.done = false;
      }
      this.ui.controlState = new _cs.chapterui.Chapter(this.ui);
      callback = (function(_this) {
        return function() {
          var j, len1, ref1;
          if (!(doneFlags.scroll && doneFlags.phaseMessage)) {
            return;
          }
          if (team === _this.enemyTeam) {
            return _this.enemyTurn.doTurn();
          } else {
            if (_this.ui.cursor.pos == null) {
              ref1 = team.units;
              for (j = 0, len1 = ref1.length; j < len1; j++) {
                unit = ref1[j];
                if (unit.id === 'ace') {
                  _this.ui.cursor.moveTo(unit.pos);
                  break;
                }
              }
            }
            _this.ui.cursor.visible = true;
            _this.ui.cursor.moveTo(_this.ui.cursor.pos);
            return _this.ui.controlState = new _cs.chapterui.Map(_this.ui);
          }
        };
      })(this);
      doneFlags = {
        scroll: false,
        phaseMessage: false
      };
      if (team instanceof _team.PlayerTeam) {
        this.turnIndex++;
        if ((this.ui.cursor.pos != null) && !this.ui.onScreen(this.ui.cursor.pos)) {
          this.ui.scrollTo(this.ui.cursor.pos, (function(_this) {
            return function() {
              doneFlags.scroll = true;
              return callback();
            };
          })(this));
        } else {
          doneFlags.scroll = true;
        }
        ref1 = this.units;
        for (j = 0, len1 = ref1.length; j < len1; j++) {
          unit = ref1[j];
          unit.onNewTurn();
        }
      } else {
        this.ui.cursor.visible = false;
        this.ui.unitInfoBox.hide();
        this.ui.terrainBox.hide();
        doneFlags.scroll = true;
        ref2 = this.units;
        for (l = 0, len2 = ref2.length; l < len2; l++) {
          unit = ref2[l];
          unit.onEnemyTurn();
        }
      }
      return this.ui.messageBox.showPhaseMessage(team, (function(_this) {
        return function() {
          doneFlags.phaseMessage = true;
          return callback();
        };
      })(this));
    };

    Chapter.prototype.checkAllDone = function() {
      var allDone, i, len, ref, unit;
      allDone = true;
      ref = this.playerTeam.units;
      for (i = 0, len = ref.length; i < len; i++) {
        unit = ref[i];
        if (!unit.done) {
          allDone = false;
          break;
        }
      }
      if (allDone) {
        return this.initTurn(this.enemyTeam);
      }
    };

    Chapter.prototype.getUnitAt = function(pos) {
      var i, len, ref, unit;
      ref = this.units;
      for (i = 0, len = ref.length; i < len; i++) {
        unit = ref[i];
        if (unit.pos.equals(pos)) {
          return unit;
        }
      }
      return null;
    };

    Chapter.prototype.render = function(ui, ctx) {
      var i, len, ref, results, unit;
      this.map.render(ui, ctx);
      if (this.playerTurn.dest != null) {
        this.playerTurn.dest.render(ui, ctx);
      }
      ref = this.units;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        unit = ref[i];
        results.push(unit.render(ui, ctx));
      }
      return results;
    };

    return Chapter;

  })();

}).call(this);
