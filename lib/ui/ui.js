// Generated by CoffeeScript 1.7.1
(function() {
  var Cursor, UI,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  UI = (function() {
    UI.prototype.tw = 35;

    function UI() {
      this.mainLoop = __bind(this.mainLoop, this);
      this.keydownHandler = __bind(this.keydownHandler, this);
      this.then = Date.now();
      this.canvas = $('canvas');
      this.ctx = this.canvas[0].getContext('2d');
      this.origin = new Position(0, 0);
      this.cursor = new Cursor(this);
      this.controlState = new CsMap(this);
      $(window).keydown(this.keydownHandler);
      this.unitInfoBox = new UnitInfoBox(this, '.sidebar .unit-info');
      this.unitInfoWindow = new UnitInfoWindow(this);
      this.actionMenu = new ActionMenu(this);
      this.weaponMenu = new WeaponMenu(this);
      this.battleStatsPanel = new BattleStatsPanel(this);
      this.messageBox = new MessageBox(this);
      this.centerOffset = new Position(this.canvas.height() / 2, this.canvas.width() / 2);
    }

    UI.prototype.setChapter = function(chapter) {
      this.chapter = chapter;
      $('.wrapper').css('width', this.canvas.width() + $('.left-sidebar').width() * 2 + 30);
      $('.game-wrapper').css('height', this.canvas.height() + 40);
      $('.victory-condition').text(this.chapter.victoryCondition.text);
      this.cursor.moveTo(new Position(0, 0));
      return this.chapter.initTurn(this.chapter.playerTeam);
    };

    UI.prototype.setCenter = function(pos) {
      return this.origin = pos.subtract(this.centerOffset);
    };

    UI.prototype.getCenter = function() {
      return this.origin.add(this.centerOffset);
    };

    UI.prototype.scrollTo = function(scrollDest, scrollCallback) {
      var center;
      this.scrollDest = scrollDest;
      this.scrollCallback = scrollCallback;
      center = this.getCenter();
      this.direction = this.scrollDest.scale(this.tw).subtract(center).toUnitVector();
      return this.scrollSpeed = .2;
    };

    UI.prototype.render = function() {
      if (this.chapter != null) {
        this.chapter.render(this, this.ctx);
      }
      return this.cursor.render(this, this.ctx);
    };

    UI.prototype.keydownHandler = function(e) {
      var _ref;
      switch (e.which) {
        case 38:
          this.controlState.up();
          break;
        case 40:
          this.controlState.down();
          break;
        case 37:
          this.controlState.left();
          break;
        case 39:
          this.controlState.right();
          break;
        case 70:
          this.controlState.f();
          break;
        case 68:
          this.controlState.d();
          break;
        case 83:
          this.controlState.s();
      }
      if ((37 <= (_ref = e.which) && _ref <= 40)) {
        e.preventDefault();
        return false;
      }
    };

    UI.prototype.update = function(delta) {
      var alt, unit, _i, _len, _ref, _results;
      if (this.direction != null) {
        this.origin = this.origin.add(this.direction.scale(delta * this.scrollSpeed));
        alt = this.scrollDest.scale(this.tw).subtract(this.getCenter());
        if (alt.dot(this.direction) <= 0) {
          this.setCenter(this.scrollDest.scale(this.tw));
          this.direction = null;
          this.scrollCallback();
        }
      }
      _ref = this.chapter.units;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        unit = _ref[_i];
        if (unit.direction != null) {
          if (unit.followingPath && (Math.abs(unit.offset.i) >= this.tw || Math.abs(unit.offset.j) >= this.tw)) {
            _results.push(unit.pathNext());
          } else {
            _results.push(unit.offset = unit.offset.add(unit.direction.scale(delta * unit.movementSpeed)));
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    UI.prototype.mainLoop = function() {
      var delta, now;
      now = Date.now();
      delta = now - this.then;
      this.then = now;
      this.update(delta);
      requestAnimationFrame(this.mainLoop);
      return this.render();
    };

    return UI;

  })();

  window.init = function() {
    var chapter;
    window.ui = new UI();
    chapter = new Chapter1(ui);
    ui.setChapter(chapter);
    return ui.mainLoop();
  };

  Cursor = (function() {
    function Cursor(ui) {
      this.ui = ui;
      this.visible = true;
    }

    Cursor.prototype.moveTo = function(pos) {
      var unitAt;
      this.pos = pos.clone();
      this.ui.chapter.playerTurn.updateDestination();
      unitAt = this.ui.chapter.getUnitAt(this.pos);
      if (unitAt === null) {
        return this.ui.unitInfoBox.hide();
      } else {
        this.ui.unitInfoBox.populate(unitAt);
        return this.ui.unitInfoBox.show();
      }
    };

    Cursor.prototype.move = function(di, dj) {
      var c, newPos, newPosPx;
      newPos = this.pos.add(new Position(di, dj));
      newPosPx = newPos.scale(this.ui.tw);
      c = this.ui.canvas;
      if (newPosPx.j >= c.width() + this.ui.origin.j || newPosPx.j < this.ui.origin.j) {
        this.ui.origin.j += dj * this.ui.tw;
      }
      if (newPosPx.i >= c.height() + this.ui.origin.i || newPosPx.i < this.ui.origin.i) {
        this.ui.origin.i += di * this.ui.tw;
      }
      return this.moveTo(newPos);
    };

    Cursor.prototype.render = function(ui, ctx) {
      var s, tw;
      if (!this.visible || (this.pos == null)) {
        return;
      }
      s = 5;
      tw = ui.tw;
      ctx.strokeStyle = 'purple';
      ctx.beginPath();
      ctx.rect(this.pos.j * tw + s - ui.origin.j, this.pos.i * tw + s - ui.origin.i, tw - 2 * s, tw - 2 * s);
      return ctx.stroke();
    };

    return Cursor;

  })();

  window.ControlState = (function() {
    function ControlState(ui) {
      this.ui = ui;
    }

    ControlState.prototype.up = function() {};

    ControlState.prototype.down = function() {};

    ControlState.prototype.left = function() {};

    ControlState.prototype.right = function() {};

    ControlState.prototype.f = function() {};

    ControlState.prototype.d = function() {};

    ControlState.prototype.s = function() {};

    return ControlState;

  })();

}).call(this);
